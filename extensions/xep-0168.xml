<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE xep SYSTEM 'xep.dtd' [
  <!ENTITY % ents SYSTEM 'xep.ent'>
%ents;
]>
<?xml-stylesheet type='text/xsl' href='xep.xsl'?>
<xep>
<header>
  <title>Resource Application Priority</title>
  <abstract>This document defines an XMPP protocol extension to indicate the presence priority of XMPP resources for applications other than messaging.</abstract>
  &LEGALNOTICE;
  <number>0168</number>
  <status>Experimental</status>
  <type>Standards Track</type>
  <sig>Standards</sig>
  <approver>Council</approver>
  <dependencies>
    <spec>XMPP Core</spec>
    <spec>XMPP IM</spec>
    <spec>XEP-0030</spec>
  </dependencies>
  <supersedes/>
  <supersededby/>
  <shortname>TO BE ASSIGNED</shortname>
  &stpeter;
  &hildjj;
  <revision>
    <version>0.4</version>
    <date>2007-06-06</date>
    <initials>psa</initials>
    <remark><p>Added section on RAP-based routing of messages sent to bare JIDs; removed RAP request protocol; changed app attribute to ns attribute; removed the application types registry since it is unnecessary if the ns attribute specifies the XML namespace of the data most closely associated with the application type; updated namespaces to conform to XMPP Registrar processes.</p></remark>
  </revision>
  <revision>
    <version>0.3</version>
    <date>2006-09-17</date>
    <initials>psa</initials>
    <remark><p>Changed im application type to messaging; added jingle-video.</p></remark>
  </revision>
  <revision>
    <version>0.2</version>
    <date>2005-12-19</date>
    <initials>psa</initials>
    <remark><p>Clarified structure of, and added schema for, RAP request namespace.</p></remark>
  </revision>
  <revision>
    <version>0.1</version>
    <date>2005-12-15</date>
    <initials>psa</initials>
    <remark><p>Initial published version.</p></remark>
  </revision>
  <revision>
    <version>0.0.6</version>
    <date>2005-11-29</date>
    <initials>psa</initials>
    <remark><p>Document cleanup.</p></remark>
  </revision>
  <revision>
    <version>0.0.5</version>
    <date>2005-11-17</date>
    <initials>psa</initials>
    <remark><p>Added support for RAP requests via IQ.</p></remark>
  </revision>
  <revision>
    <version>0.0.4</version>
    <date>2005-10-27</date>
    <initials>psa/jjh</initials>
    <remark><p>Defined registry of application types; clarified business rules; corrected schema.</p></remark>
  </revision>
  <revision>
    <version>0.0.3</version>
    <date>2005-10-24</date>
    <initials>psa/jjh</initials>
    <remark><p>Broadened previous resource flagging proposal to include priority for applications other than messaging.</p></remark>
  </revision>
  <revision>
    <version>0.0.2</version>
    <date>2005-09-26</date>
    <initials>psa/jjh</initials>
    <remark><p>Added more business rules and examples; defined service discovery guidelines.</p></remark>
  </revision>
  <revision>
    <version>0.0.1</version>
    <date>2005-09-23</date>
    <initials>psa/jjh</initials>
    <remark><p>First draft.</p></remark>
  </revision>
</header>
<section1 topic='Introduction' anchor='intro'>
  <p>Within the Extensible Messaging and Presence Protocol (XMPP; see &rfc3920;), presence indicates availability for communication -- specifically, communication via XMPP messaging in the "jabber:client" namespace (usually in the form of "instant messaging" or IM as described in &rfc3921;). However, a wide variety of entities might provide XMPP presence, including entities that are not primarily focused on IM (e.g., phones) or even entities that do not support XMPP messaging at all.</p>
  <p>Consider a scenario in which a contact wants to initiate a voice chat (e.g., via &xep0166;) with a user who has the following three XMPP resources:</p>
  <table caption='Application Presence'>
  <tr>
    <th>Resource</th>
    <th>Messaging Priority</th>
    <th>Voice Chat Priority</th>
  </tr>
  <tr>
    <td>desktop</td>
    <td>10</td>
    <td>5</td>
  </tr>
  <tr>
    <td>pda</td>
    <td>5</td>
    <td>-1</td>
  </tr>
  <tr>
    <td>mobile</td>
    <td>-1</td>
    <td>10</td>
  </tr>
  </table>
  <p>If the contact chooses the resource with which it initiates a voice chat based on the user's default XMPP presence priority (i.e., priority for XMPP messaging), the resulting behavior could be misleading (i.e., initiating the voice chat with the "desktop" resource rather than the "mobile" resource).</p>
  <p>What is needed is a way for the user's clients to indicate that the application priority for the three resources is different from the standard XMPP messaging priority. Such information can also be used by an XMPP to route XMPP &MESSAGE; stanzas directed to a user's bare JID (&BAREJID;). This document defines such a mechanism via an optional XMPP presence extension.</p>
  <p>In addition, this document also defines a way for an XMPP server to flag which resource it considers to be primary for any given application type, if it has information -- such as communication preferences -- that can help determine the primary resource.</p>
</section1>
<section1 topic='Application Priority' anchor='primary'>
  <p>Consider the three resources ("desktop", "pda", and "mobile") mentioned above. The presence stanzas received by a contact for those three resources would be as follows &NSNOTE;:</p>
  <example caption='Contact receives presence from user'><![CDATA[
<presence from='juliet@capulet.com/desktop' to='romeo@montague.net/home'>
  <priority>10</priority>
  <rap xmlns='http://www.xmpp.org/extensions/xep-0168.html#ns' 
       ns='http://www.xmpp.org/extensions/xep-0167#ns' 
       num='5'/>
</presence>

<presence from='juliet@capulet.com/pda' to='romeo@montague.net/home'>
  <priority>5</priority>
  <rap xmlns='http://www.xmpp.org/extensions/xep-0168.html#ns' 
       ns='http://www.xmpp.org/extensions/xep-0167#ns' 
       num='-1'/>
</presence>

<presence from='juliet@capulet.com/mobile' to='romeo@montague.net/home'>
  <priority>-1</priority>
  <rap xmlns='http://www.xmpp.org/extensions/xep-0168.html#ns' 
       ns='http://www.xmpp.org/extensions/xep-0167#ns' 
       num='10'/>
</presence>
  ]]></example>
  <p>(Note: This protocol uses a 'num' attribute rather than a 'priority' attribute to reduce confusion with XMPP presence.)</p>
  <p>The following business rules apply to resource application presence provided by the client:</p>
  <ol start='1'>
    <li><p>A client SHOULD NOT specify resource application presence if the priority for that application is the same as the resource's XMPP messaging priority.</p></li>
    <li><p>A client MUST NOT generate a &lt;rap/&gt; element that has a 'ns' attribute whose value is "jabber:client" or that has no 'ns' attribute (since the default 'ns' is "jabber:client").</p></li>
  </ol>
</section1>
<section1 topic='Flagging the Primary Resource' anchor='flag'>
  <p>The user's server may have special information that enables it to flag a resource as primary for a given application type. For instance, the server may include a communication policy service that enables the user to define (outside the context of any presence priorities) that she would prefer to be called at her desktop computer only between the hours of 9:00 AM and 5:00 PM local time, prefer to be called on her mobile phone at all other times, and so on.</p>
  <p>To flag the primary resource related to a specific application type, the server shall add a &lt;primary/&gt; child to the relevant RAP element. Here is an example:</p>
  <example caption='Primary resource flag'><![CDATA[
<presence from='juliet@capulet.com/mobile'>
  <priority>-1</priority>
  <rap xmlns='http://www.xmpp.org/extensions/xep-0168.html#ns' 
       ns='http://www.xmpp.org/extensions/xep-0167#ns' 
       num='10'>
    <primary/>
  </rap>
</presence>
  ]]></example>
  <p>The following business rules apply to resource flagging by the server:</p>
  <ol start='1'>
    <li><p>A server MAY add the primary resource flag to the presence broadcasts generated by the resource it determines is "most available" for a given application type.</p></li>
    <li><p>Because the default 'ns' is "jabber:client", to flag the primary resource for XMPP messaging the server SHOULD NOT include a 'ns' attribute, SHOULD NOT include a 'num' attribute, and MUST include a &lt;primary/&gt; child.</p></li>
    <li><p>An available resource that has specified a negative priority for an application type MUST NOT be flagged as the primary resource for that application type.</p></li>
    <li><p>A client SHOULD NOT include the primary resource flag in presence stanzas that it generates; however, if a client includes the primary resource flag in a presence stanza, the server SHOULD remove or overwrite the flag.</p></li>
    <li><p>In response to a presence probe, a server SHOULD send presence from the primary resource first (this enables the receiving client to skip any local most-available algorithms it might implement).</p></li>
    <li><p>If the primary resource changes for a given application type, a server MUST push presence (including the primary resource flag) for the new primary resource. If the change in primary resource occurs because of a presence broadcast from the current primary resource, the server MUST push presence from the current primary resource (without the primary resource flag) before pushing presence from the new primary resource (including the primary resource flag).</p></li>
  </ol>
</section1>
<section1 topic='RAP-Based Message Routing' anchor='route'>
  <p>A server MAY use the RAP data provided by clients in order to route incoming &MESSAGE; stanzas directed to the bare JID (&BAREJID;) of a registered account. In order to enable such routing, the sender MUST include an empty &lt;route/&gt; element qualified by the 'http://www.xmpp.org/extensions/xep-0168.html#ns-raproute' namespace &NSNOTE; including an 'ns' attribute corresponding to the desired application.</p>
  <p>For example, consider a &xep0155; request send from one user (Romeo) to another (Juliet), where the users do not share presence:</p>
  <example caption="User requests session"><![CDATA[
<message type='headline'
         from='romeo@montague.net/orchard'
         to='juliet@capulet.com'>
  <route xmlns='http://www.xmpp.org/extensions/xep-0168.html#ns-raproute'
         ns='http://www.xmpp.org/extensions/xep-0167#ns'/>
  <thread>ffd7076498744578d10edabfe7f4a866</thread>
  <feature xmlns='http://jabber.org/protocol/feature-neg'>
    <x xmlns='jabber:x:data' type='form'>
      <title>Open chat with Romeo?</title>
      <field var='FORM_TYPE' type='hidden'>
        <value>urn:xmpp:ssn</value>
      </field>
      <field label='Accept this session?' type='boolean' var='accept'>
        <value>true</value>
        <required/>
      </field>
      ...
  </feature>
</message>
    ]]></example>
    <p>If Juliet's server supports RAP routing, it would then deliver the message to whichever of Juliet's resources has the highest priority for the "http://www.xmpp.org/extensions/xep-0167#ns" application type.</p>
</section1>
<section1 topic='Determining Support' anchor='disco'>
  <p>In order to discover whether a server or other entity supports this protocol, an entity MUST use &xep0030;.</p>
  <example caption='Entity queries a server regarding protocol support'><![CDATA[
<iq type='get'
    from='juliet@capulet.com/balcony'
    to='capulet.com'
    id='disco1'>
  <query xmlns='http://jabber.org/protocol/disco#info'/>
</iq>
  ]]></example>
  <p>If the queried entity supports the functionality specified herein, it MUST return the following features &NSNOTE;:</p>
  <ul>
    <li>For RAP, "http://www.xmpp.org/extensions/xep-0168.html#ns"</li>
    <li>For RAP routing, "http://www.xmpp.org/extensions/xep-0168.html#ns-route"</li>
  </ul>
  <example caption='Server communicates protocol support for RAP'><![CDATA[
<iq type='result'
    from='capulet.com'
    to='juliet@capulet.com/balcony'
    id='disco1'>
  <query xmlns='http://jabber.org/protocol/disco#info'>
    ...
    <feature var='http://www.xmpp.org/extensions/xep-0168.html#ns'/>
    <feature var='http://www.xmpp.org/extensions/xep-0168.html#ns-route'/>
    ...
  </query>
</iq>
  ]]></example>
</section1>
<section1 topic='Security Considerations' anchor='security'>
  <p>Neither client publishing of resource application priority nor server flagging of the primary resource introduces any known security vulnerabilities or compromises of user privacy.</p>
</section1>
<section1 topic='IANA Considerations' anchor='iana'>
  <p>This document requires no interaction with &IANA;.</p>
</section1>
<section1 topic='XMPP Registrar Considerations' anchor='registrar'>
  <section2 topic='Protocol Namespaces' anchor='registrar-ns'>
    <p>Until this specification advances to a status of Draft, its associated namespaces shall be:</p>
    <ul>
      <li>http://www.xmpp.org/extensions/xep-0168.html#ns</li>
      <li>http://www.xmpp.org/extensions/xep-0168.html#ns-route</li>
    </ul>
    <p>Upon advancement of this specification, the &REGISTRAR; shall issue permanent namespaces in accordance with the process defined in Section 4 of &xep0053;.</p>
  </section2>
</section1>
<section1 topic='XML Schemas' anchor='schema'>
  <section2 topic='RAP' anchor='schema-rap'>
    <code><![CDATA[
<?xml version='1.0' encoding='UTF-8'?>

<xs:schema
    xmlns:xs='http://www.w3.org/2001/XMLSchema'
    targetNamespace='http://www.xmpp.org/extensions/xep-0168.html#ns'
    xmlns='http://www.xmpp.org/extensions/xep-0168.html#ns'
    elementFormDefault='qualified'>

  <xs:element name='rap'>
    <xs:complexType>
      <xs:sequence>
        <xs:element name='primary' type='empty' minOccurs='0'/>
      </xs:sequence>
      <xs:attribute name='ns' type='xs:string' default='jabber:client'/>
      <xs:attribute name='num' type='xs:byte'/>
    </xs:complexType>
  </xs:element>

  <xs:simpleType name='empty'>
    <xs:restriction base='xs:string'>
      <xs:enumeration value=''/>
    </xs:restriction>
  </xs:simpleType>
</xs:schema>

    ]]></code>
  </section2>
  <section2 topic='RAP Routing' anchor='schema-raproute'>
    <code><![CDATA[
<?xml version='1.0' encoding='UTF-8'?>

<xs:schema
    xmlns:xs='http://www.w3.org/2001/XMLSchema'
    targetNamespace='http://www.xmpp.org/extensions/xep-0168.html#ns-route'
    xmlns='http://www.xmpp.org/extensions/xep-0168.html#ns-route'
    elementFormDefault='qualified'>

  <xs:element name='route'>
    <xs:complexType>
      <xs:simpleContent>
        <xs:extension base='empty'>
          <xs:attribute name='ns' type='xs:string' default='jabber:client'/>
        </xs:extension>
      </xs:simpleContent>
    </xs:complexType>
  </xs:element>

  <xs:simpleType name='empty'>
    <xs:restriction base='xs:string'>
      <xs:enumeration value=''/>
    </xs:restriction>
  </xs:simpleType>
</xs:schema>

    ]]></code>
  </section2>
</section1>
</xep>
