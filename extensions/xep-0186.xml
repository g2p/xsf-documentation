<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE xep SYSTEM 'xep.dtd' [
  <!ENTITY % ents SYSTEM 'xep.ent'>
%ents;
]>
<?xml-stylesheet type='text/xsl' href='xep.xsl'?>
<xep>
<header>
  <title>Invisible Command</title>
  <abstract>This document specifies an XMPP-compatible protocol for user invisibility.</abstract>
  &LEGALNOTICE;
  <number>0186</number>
  <status>Experimental</status>
  <type>Standards Track</type>
  <sig>Standards</sig>
  <dependencies>
    <spec>XMPP Core</spec>
    <spec>XMPP IM</spec>
    <spec>XEP-0030</spec>
  </dependencies>
  <supersedes>None</supersedes>
  <supersededby>None</supersededby>
  <shortname>NOT YET ASSIGNED</shortname>
  &stpeter;
  <revision>
    <version>0.5</version>
    <date>2007-01-30</date>
    <initials>psa</initials>
    <remark><p>Modified XML namespace name to conform to XEP-0053 processes.</p></remark>
  </revision>
  <revision>
    <version>0.4</version>
    <date>2006-08-09</date>
    <initials>psa</initials>
    <remark><p>Added XMPP Registrar considerations and XML schema.</p></remark>
  </revision>
  <revision>
    <version>0.3</version>
    <date>2006-08-02</date>
    <initials>psa</initials>
    <remark><p>Added inbound presence rule to server handling section.</p></remark>
  </revision>
  <revision>
    <version>0.2</version>
    <date>2006-07-07</date>
    <initials>psa</initials>
    <remark><p>Clarified that invisibility mode does not carry across sessions.</p></remark>
  </revision>
  <revision>
    <version>0.1</version>
    <date>2006-05-30</date>
    <initials>psa</initials>
    <remark><p>Initial version.</p></remark>
  </revision>
  <revision>
    <version>0.0.2</version>
    <date>2006-05-15</date>
    <initials>psa</initials>
    <remark><p>Recommended delivery of messages sent to bare JID.</p></remark>
  </revision>
  <revision>
    <version>0.0.1</version>
    <date>2006-05-11</date>
    <initials>psa</initials>
    <remark><p>First draft.</p></remark>
  </revision>
</header>
<section1 topic='Introduction' anchor='intro'>
  <p>Some instant messaging implementations of the Jabber/XMPP protocols have long supported the ability for IM users to be online but appear invisible. The existing protocols for doing so are:</p>
  <ul>
    <li><p>&xep0018; -- this protocol is not compatible with &xmppcore; and &xmppim;, and the speciifcation does not provide reliable documentation of the protocol in use since many server implementations support presence of type "invisible" but not presence of type "visible".</p></li>
    <li><p>&xep0126; -- this protocol is in many ways a mis-use of privacy lists for the temporary purpose of appearing invisible rather than the intended purpose of permanently blocking communications.</p></li>
  </ul>
  <p>In order to provide a standards-compliant protocol that can be used in the long term, this document defines an IQ-based protocol that enables an IM user to "go invisible" and "go visible" at will within the context of a given session.</p>
</section1>
<section1 topic='Requirements' anchor='req'>
  <p>The requirements for invisible mode are straightforward:</p>
  <ol start='1'>
    <li>A user should be able to become visible or invisible at any time within an XMPP session.</li>
    <li>Invisible mode is active only for the current session; if the user ends that session and starts another session, the invisibility mode set for the previous session does not carry over to the new session.</li>
    <li>When in invisible mode, a user should be able to send directed presence to particular contacts.</li>
  </ol>
</section1>
<section1 topic='Use Cases' anchor='usecases'>
  <section2 topic='Discovering Support' anchor='disco'>
    <p>In order for a client to discover whether its server supports the protocol defined herein, it MUST send a &xep0030; information request to the server:</p>
    <example caption='Service discovery request'><![CDATA[
<iq from='bilbo@tolkien.lit/shire' to='tolkien.lit' type='get' id='disco1'>
  <query xmlns='http://jabber.org/protocol/disco#info'/>
</iq>
    ]]></example>
    <p>If the server supports the protocol defined herein, it MUST return a feature of "http://www.xmpp.org/extensions/xep-0186.html#ns":</p>
    <example caption='Service discovery response'><![CDATA[
<iq from='bilbo@tolkien.lit/shire' to='tolkien.lit' type='get' id='disco1'>
  <query xmlns='http://jabber.org/protocol/disco#info'>
    ...
    <feature var='http://www.xmpp.org/extensions/xep-0186.html#ns'/>
    ...
  </query>
</iq>
    ]]></example>
    <p>A client SHOULD complete this service discovery process before sending initial presence to its server.</p>
  </section2>
  <section2 topic='User Becomes Invisible' anchor='invisible'>
    <p>In order for a client to go invisible, it shall send an IQ-set with no 'to' address (thus handled by the user's server) containing an &lt;invisible/&gt; element qualified by the 'http://www.xmpp.org/extensions/xep-0186.html#ns' namespace:</p>
    <example caption='Invisible command'><![CDATA[
<iq type='set' id='inv1'>
  <invisible xmlns='http://www.xmpp.org/extensions/xep-0186.html#ns'/>
</iq>
    ]]></example>
    <p>If the server can successfully process the invisibility command, it MUST return an IQ-result:</p>
    <example caption='Invisible command is successful'><![CDATA[
<iq type='result' id='inv1'/>
    ]]></example>
    <p>(Standard XMPP stanza errors apply; see <cite>RFC 3920</cite> and &xep0086;.)</p>
    <p>If the client enters invisible mode after having previously sent undirected presence with no 'type' attribute (e.g., after sending initial presence), the server MUST send &UNAVAILABLE; presence from the client's resource to all contacts who would receive unavailable presence if the client sent &UNAVAILABLE;.</p>
    <p>While the client is in invisible mode, the server:</p>
    <ol start='1'>
      <li><p>MUST NOT broadcast presence notifications as a result of receiving any subsequent undirected presence notifications from the client.</p></li>
      <li><p>MUST deliver directed presence stanzas generated by the client.</p></li>
      <li><p>MUST deliver inbound &PRESENCE; stanzas.</p></li>
      <li><p>SHOULD deliver inbound &MESSAGE; stanzas whose 'to' address is the bare JID (&BAREJID;) of the user (subject to standard XMPP stanza handling rules).</p></li>
      <li><p>MUST deliver inbound &MESSAGE; and &IQ; stanzas whose 'to' address is the full JID (&FULLJID;) corresponding to the resource of the client.</p></li>
      <li><p>MUST deliver outbound &MESSAGE; and &IQ; stanzas generated by the client (for an important note regarding presence leaks, see the <link url='#security'>Security Considerations</link> section of this document).</p></li>
    </ol>
    <p>If after sending directed presence the client then sends &UNAVAILABLE;, the server MUST deliver that unavailable presence only to the entities to which the client sent directed presence after going invisible.</p>
  </section2>
  <section2 topic='User Becomes Visible' anchor='visible'>
    <p>In order for a client to become visible again, it shall send an IQ-set with no 'to' address (thus handled by the user's server) containing a &lt;visible/&gt; element qualified by the 'http://www.xmpp.org/extensions/xep-0186.html#ns' namespace:</p>
    <example caption='Visible command'><![CDATA[
<iq type='set' id='vis1'>
  <visible xmlns='http://www.xmpp.org/extensions/xep-0186.html#ns'/>
</iq>
    ]]></example>
    <p>If the server can successfully process the visibility command, it MUST return an IQ-result:</p>
    <example caption='Visible command is successful'><![CDATA[
<iq type='result' id='vis1'/>
    ]]></example>
    <p>When the client becomes visible, the server MUST treat that state as equivalent to an active session before receiving initial presence from the client. It is the responsibility of the client to send an undirected presence notification to the server, which the server MUST broadcast to all entities who would normally receive presence broadcasts from the client (as well as any other entities to which the client sent directed presence while invisible).</p>
  </section2>
</section1>
<section1 topic='Security Considerations' anchor='security'>
  <p>It is possible to leak presence while in invisible mode (for example, by sending a message, IQ, or presence stanza to a contact). A client SHOULD warn a user before allowing the client to generate any outbound traffic and MUST NOT respond to IQ requests received from entities with which it has not initiated communications while in invisible mode (e.g., by sending messages, IQs, or directed presence).</p>
</section1>
<section1 topic='IANA Considerations' anchor='iana'>
  <p>No interaction with &IANA; is required as a result of this document.</p>
</section1>
<section1 topic='XMPP Registrar Considerations' anchor='registrar'>
  <section2 topic='Protocol Namespaces' anchor='ns'>
    <p>Until this specification advances to a status of Draft, its associated namespace shall be "http://www.xmpp.org/extensions/xep-00186.html#ns"; upon advancement of this specification, the &REGISTRAR; shall issue a permanent namespace in accordance with the process defined in Section 4 of &xep0053;.</p>
  </section2>
</section1>
<section1 topic='XML Schema' anchor='schema'>
  <code><![CDATA[
<?xml version='1.0' encoding='UTF-8'?>

<xs:schema
    xmlns:xs='http://www.w3.org/2001/XMLSchema'
    targetNamespace='http://www.xmpp.org/extensions/xep-0186.html#ns'
    xmlns='http://www.xmpp.org/extensions/xep-0186.html#ns'
    elementFormDefault='qualified'>

  <xs:element name='invisible' type='empty'/>

  <xs:element name='visible' type='empty'/>

  <xs:simpleType name='empty'>
    <xs:restriction base='xs:string'>
      <xs:enumeration value=''/>
    </xs:restriction>
  </xs:simpleType>

</xs:schema>
  ]]></code>
</section1>
</xep>
